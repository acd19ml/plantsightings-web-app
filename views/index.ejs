<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel='stylesheet' href='/stylesheets/style.css' />
</head>
<body>
<h1><%= title %></h1>

<!-- Sort Dropdown Menu -->
<div class="container">
    <div class="row">
        <div class="col">
            <form action="/" method="GET" id="sortForm">
                <div class="form-group">
                    <label for="sortOrder">Sort By:</label>
                    <select name="sortOrder" id="sortOrder" class="form-control" onchange="handleSortChange(this)">
                        <option value="newest" <%= sortOrder === 'newest' ? 'selected' : '' %>>Date (Newest)</option>
                        <option value="oldest" <%= sortOrder === 'oldest' ? 'selected' : '' %>>Date (Oldest)</option>
                        <option value="distance" <%= sortOrder === 'distance' ? 'selected' : '' %>>Distance</option>
                    </select>
                </div>
            </form>
        </div>
    </div>
    <div class="container">
        <form action="/" method="GET">
            <div class="row">
                <!-- Existing filters here -->
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="status">Identification Status:</label>
                        <select name="status" id="status" class="form-control" onchange="this.form.submit()">
                            <option value="">All</option>
                            <option value="completed" <%= filters.status === 'completed' ? 'selected' : '' %>>Completed</option>
                            <option value="in-progress" <%= filters.status === 'in-progress' ? 'selected' : '' %>>In Progress</option>
                        </select>
                    </div>
                </div>
                <!-- End of new filter for status -->
            </div>
        </form>
    </div>
    <!-- Filtering Menu for Flower -->
    <div class="container">
        <!-- Flower Filter -->
        <form action="/" method="GET">
            <div class="form-group">
                <label for="flowers">Flowers:</label>
                <select name="flowers" id="flowers" class="form-control" onchange="this.form.submit()">
                    <option value="">All</option>
                    <option value="true" <%= filters.flowers === 'true' ? 'selected' : '' %>>With Flowers</option>
                    <option value="false" <%= filters.flowers === 'false' ? 'selected' : '' %>>Without Flowers</option>
                </select>
            </div>
            <!-- Additional filters for leaves, fruits or seeds, and sun exposure -->
            <div class="form-group">
                <label for="leaves">Leaves:</label>
                <select name="leaves" id="leaves" class="form-control" onchange="this.form.submit()">
                    <option value="">All</option>
                    <option value="true" <%= filters.leaves === 'true' ? 'selected' : '' %>>With Leaves</option>
                    <option value="false" <%= filters.leaves === 'false' ? 'selected' : '' %>>Without Leaves</option>
                </select>
            </div>
            <div class="form-group">
                <label for="fruitsOrSeeds">Fruits/Seeds:</label>
                <select name="fruitsOrSeeds" id="fruitsOrSeeds" class="form-control" onchange="this.form.submit()">
                    <option value="">All</option>
                    <option value="true" <%= filters.fruitsOrSeeds === 'true' ? 'selected' : '' %>>With Fruits/Seeds</option>
                    <option value="false" <%= filters.fruitsOrSeeds === 'false' ? 'selected' : '' %>>Without Fruits/Seeds</option>
                </select>
            </div>
            <div class="form-group">
                <label for="sunExposure">Sun Exposure:</label>
                <select name="sunExposure" id="sunExposure" class="form-control" onchange="this.form.submit()">
                    <option value="">All</option>
                    <option value="full sun" <%= filters.sunExposure === 'full sun' ? 'selected' : '' %>>Full Sun</option>
                    <option value="partial shade" <%= filters.sunExposure === 'partial shade' ? 'selected' : '' %>>Partial Shade</option>
                    <option value="full shade" <%= filters.sunExposure === 'full shade' ? 'selected' : '' %>>Full Shade</option>
                </select>
            </div>
        </form>
    </div>


<!-- Plant Sightings Display -->
<div class="container">
    <div class="row">
        <% data.forEach(plantsighting => { %>
            <div class="col-sm-6 col-md-4 col-lg-3">
                <a href="/display/<%= plantsighting._id %>"><img src="<%= plantsighting.photo %>" class="img-thumbnail" width="200" height="200" alt="Plant Photo"></a>
                <p><strong>Date Seen:</strong> <%= plantsighting.dateSeen.toDateString() %></p>
                <% if (plantsighting.location && plantsighting.location.coordinates) { %>
                    <!-- Hidden latitude and longitude -->
                    <span style="display: none;" id="lat_<%= plantsighting._id %>"><%= plantsighting.location.coordinates[1] %></span>
                    <span style="display: none;" id="long_<%= plantsighting._id %>"><%= plantsighting.location.coordinates[0] %></span>
                <% } %>
                <% if (sortOrder === 'distance' && plantsighting.distance != null) { %>
                    <p><strong>Distance:</strong> <%= plantsighting.distance.toFixed(2) + ' km' %></p>
                <% } %>
            </div>
        <% }); %>
    </div>
</div>
<hr>
<a href="/add"><p>Add New Plant Sighting</p></a>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var dbRequest = indexedDB.open('MyDatabase', 1);

            dbRequest.onsuccess = function(event) {
                var db = event.target.result;
                var transaction = db.transaction('nicknames', 'readonly');
                var store = transaction.objectStore('nicknames');
                var getRequest = store.get('userNickname');

                getRequest.onsuccess = function() {
                    var userNickname = getRequest.result ? getRequest.result.nickname : '';
                    var myPlantsButton = document.getElementById('myPlants');
                    if (userNickname) {
                        myPlantsButton.addEventListener('click', function() {
                            // Redirect to the homepage with the nickname as a query parameter
                            window.location.href = `/?nickname=${userNickname}`;
                        });
                    } else {
                        // If no nickname is found, redirect to a page to set nickname
                        window.location.href = '/nickname';  // Redirect to the nickname setup page
                    }
                };

                getRequest.onerror = function() {
                    // Handle errors, e.g., when the object store could not be accessed
                    console.error('Error fetching nickname from IndexedDB');
                    window.location.href = '/error';  // Redirect to an error handling page
                };
            };

            dbRequest.onerror = function() {
                // Handle errors when opening the database fails
                console.error('Error opening IndexedDB');
                window.location.href = '/error';  // Redirect to an error handling page
            };

            // Event listener for the "Show All Plants" button
            var showAllButton = document.getElementById('showAll');
            if (showAllButton) {
                showAllButton.addEventListener('click', function() {
                    window.location.href = '/';
                });
            }
        });
    </script>



    <div class="container">
        <button id="myPlants" class="btn btn-primary">Show My Plants</button>
        <button id="showAll" class="btn btn-secondary">Show All Plants</button>
    </div>



</body>
<script src="/javascripts/distance.js"></script>
</html>



