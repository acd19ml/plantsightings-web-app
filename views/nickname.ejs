<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>nickname</title>
        <link rel='stylesheet' href='/stylesheets/add.css'/>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body>
    <div class="container">
        <h1 class="text-center">Add a Nickname for yourself.</h1>
        <br>
        <form action="/nickname" method="POST" enctype="multipart/form-data">
            <div class="col-md-5">
                <!--                nickname-->
                <div class="mb-3">
                    <label for="nickname" class="form-label">Nickname:</label>
                    <input class="form-control" type="text" id="nickname" name="nickname" required>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var db;
            var request = indexedDB.open('MyDatabase', 1);

            request.onupgradeneeded = function(event) {
                var db = event.target.result;
                if (!db.objectStoreNames.contains('nicknames')) {
                    db.createObjectStore('nicknames', {keyPath: 'id'});
                }
            };

            request.onerror = function(event) {
                console.error("IndexedDB error:", event.target.errorCode);
            };

            request.onsuccess = function(event) {
                db = event.target.result;
                var form = document.querySelector('form');
                form.addEventListener('submit', function(event) {
                    event.preventDefault(); // Stop the form from submitting immediately

                    var nickname = document.getElementById('nickname').value;
                    var tx = db.transaction('nicknames', 'readwrite');
                    var store = tx.objectStore('nicknames');
                    var addNickname = store.put({ id: 'userNickname', nickname: nickname });

                    addNickname.onsuccess = function() {
                        console.log('Nickname saved to IndexedDB:', nickname);
                        var getNick = store.get('userNickname');
                        getNick.onsuccess = function() {
                            document.getElementById('nickname').value = getNick.result.nickname; // Update the form field
                            form.submit(); // Now submit the form
                        };
                    };

                    addNickname.onerror = function(event) {
                        console.error('Error saving nickname to IndexedDB:', event.target.errorCode);
                    };

                    tx.oncomplete = function() {
                        console.log('Transaction completed.');
                    };

                    tx.onerror = function(event) {
                        console.error('Transaction error:', event.target.errorCode);
                    };
                });
            };
        });
    </script>



    </body>
</html>